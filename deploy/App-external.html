<!DOCTYPE html>
<html>
<head>
    <title>Random App Name5398</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",componentCls:"app",html:'<table><tr><td><div title="Create a task and assign it with estimate or enter initial capacity on the Team Status page."><b style="text-align:left;float:left;"></b></div></td><td><div><input type="button" style="text-align:right;float:right;" value="Refresh" onClick="javascript: app.onScopeChange();"/></div></td></tr></table>',comboboxConfig:{fieldLabel:"Select an release:</div>",width:400},onScopeChange:function(timeboxscope){console.log("onScopeChange");var iterationStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["Name","UserIterationCapacities:summary","WorkProducts:summary","Project"],filters:[{property:"StartDate",operator:">=",value:timeboxscope.getRecord().get("formattedStartDate")},{property:"EndDate",operator:"<=",value:timeboxscope.getRecord().get("formattedEndDate")}],sorters:[{property:"StartDate",direction:"ASC"}],pageSize:200,limit:1e3});iterationStore.load().then({success:function(results){console.log("iterationStore load promise success"),sprintNames=this._getIterationNames(results),Deft.Promise.all([this._loadCapacities(results),this._loadStories(results)]).then({success:function(loadresults){var datarecords=this._processLoadResults(loadresults);this._displayGrid(datarecords,sprintNames)},failure:function(){console.log("results:Deft.Promise.all() failure")},scope:this})},failure:function(){console.log("iterationStore load promise failure")},scope:this})},_getIterationNames:function(iterations){var iterNames=[];return _.each(iterations,function(iter){iterNames.includes(iter.get("Name"))||iterNames.push(iter.get("Name"))}),iterNames},_loadCapacities:function(iterations){var promises=[];return _.each(iterations,function(iteration){var uics=iteration.get("UserIterationCapacities");uics.Count>0&&(uics.store=iteration.getCollection("UserIterationCapacities"),promises.push(uics.store.load()))}),console.log(promises),Deft.Promise.all(promises)},_loadStories:function(iterations){var uspromises=[];return _.each(iterations,function(iteration){if(iteration.get("WorkProducts").Count>0){var storyStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",fetch:["Owner","PlanEstimate","Iteration"],filters:[{property:"Iteration.ObjectID",operator:"=",value:iteration.get("ObjectID")}],sorter:[{property:"Owner"}],pageSize:200});uspromises.push(storyStore.load())}}),Deft.Promise.all(uspromises)},_processLoadResults:function(loadresults){var temprecords=[];_.each(loadresults[0],function(sprint_uics){_.each(sprint_uics,function(uic){var sprint=uic.get("Iteration")._refObjectName,user=uic.get("User")._refObjectName,capacity=Ext.util.Format.round(uic.get("Capacity")/6,1),temprec=temprecords.find(function findOwner(temprecords){return temprecords.user===user});void 0===temprec&&(temprec={},temprec.user=user,temprecords.push(temprec)),void 0===temprec[sprint]&&(temprec[sprint]={},temprec[sprint].name=sprint,temprec[sprint].toString=function(){return this.name}),temprec[sprint].capacityPts=capacity,temprec[sprint].storyPts=0,temprec[sprint].load=0})}),_.each(loadresults[1],function(sprint_stories){_.each(sprint_stories,function(story){var sprint=story.get("Iteration")._refObjectName,user;user=null===story.get("Owner")?"no owner":story.get("Owner")._refObjectName;var points;points=story.get("PlanEstimate")>0?story.get("PlanEstimate"):0;var temprec=temprecords.find(function findOwner(temprecords){return temprecords.user===user});void 0===temprec&&(temprec={},temprec.user=user,temprecords.push(temprec)),void 0===temprec[sprint]&&(temprec[sprint]={},temprec[sprint].name=sprint,temprec[sprint].capacityPts=0,temprec[sprint].storyPts=0,temprec[sprint].load=0,temprec[sprint].toString=function(){return this.name}),temprec[sprint].storyPts+=points,temprec[sprint].capacityPts>0&&temprec[sprint].storyPts>0&&(temprec[sprint].load=Ext.util.Format.round(temprec[sprint].storyPts/temprec[sprint].capacityPts,1))})});var gridrecords=[];return _.each(temprecords,function(rec){var gridrec={};for(var prop in rec)"user"===prop?gridrec.Owner=rec.user:gridrec[prop.replace(/[ .]/g,"_")]=rec[prop].load;gridrecords.push(gridrec)}),gridrecords},_calcLoad:function(l,c){return Ext.util.Format.round(l/c,1)},_displayGrid:function(datarecords,sprintNames){var cstore=Ext.create("Rally.data.custom.Store",{data:datarecords,sorters:[{property:"Owner",direction:"ASC"}]});cstore.loadData(datarecords);var columns=[{text:"Owner",dataIndex:"Owner",width:100}];_.each(sprintNames,function(name){columns.push({text:name.replace(/[ .]/g,"_"),align:"center",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:name.replace(/[ .]/g,"_"),calculateColorFn:function(recordData){var loadval=recordData[name.replace(/[ .]/g,"_")];return colVal=loadval>0&&.8>=loadval?"#B2E3B6":loadval>.8&&1>=loadval?"#006600":loadval>1&&1.25>loadval?"#FCB5B1":"#f61509"}})})}),this._myGrid&&this._myGrid.destroy(),this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygridboard",showRowActionsColumn:!1,store:cstore,columnCfgs:columns,title:"PI Iterations US Point load/capacity"}),this.add(this._myGrid)}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name5398",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
